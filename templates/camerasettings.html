{% extends 'base.html' %}

{% block content %}

<div class="container-xxl">
    <div class="row">
        <div class="col-lg-8 pt-5">
            <!-- ###### Main Content ###### -->
            <h2 class="pt-4 pb-2 mb-4 border-bottom">Camera Feed</h2>
            <img class="img-fluid" id="cameraImage" alt="Camera Feed">
            <div class="pt-3 row">
                <div class="d-grid gap-2 col-4 mx-auto">
                    <button type="button" class="btn btn-primary btn-success btn-lg" id="captureButton" onclick="capturePhoto()">Capture Image</button>
                    <!--<button type="button" class="btn btn-primary btn-info btn-lg" id="starttimelapseButton" onclick="start_timelapse()">Start Timelapse</button>-->
                    <!--<button type="button" class="btn btn-primary btn-danger btn-lg" id="stoptimelapseButton" onclick="stop_timelapse()">Stop Timelapse</button>-->
                </div>
                <div class="col-8">
                    <div id="captureAlert" class="alert" role="alert" style="display: none;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 pt-5 pb-4 overflow-y-scroll" style="height: 100vh; height: -webkit-fill-available; max-height: 100vh; overflow-x: auto; overflow-y: hidden;">
            <!-- ###### Side Bar ###### -->
            <div class="accordion pt-4" id="accordionExample">
            <!-- ###### Orientation Settings ###### -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#orientationSettings" aria-expanded="false" aria-controls="orientationSettings">
                    Orientation
                </button>
                </h2>
                <div id="orientationSettings" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        <!-- Orientation -->
                        <div class="d-flex w-100 align-items-center justify-content-between">
                            <strong class="mb-1">Flip Camera Feed</strong>
                                <a data-bs-toggle="collapse" href="#orientation_info" role="button" aria-expanded="false" aria-controls="collapseExample">
                                <i class="bi bi-info-circle"></i></a>
                        </div>
                        <div class="collapse p-2" id="orientation_info">
                            <div class="card card-body">
                                <p class="mb-0">This setting does not rotate the camera feed but actually flips the image like a mirror in the horizontal or vertical plane.</p>
                                <p class="mb-0">Make your selection and press 'Apply'</p>
                                    <div class="alert alert-warning" role="alert">
                                    Camera feed will need to be restarted for this setting to be applied.
                                    </div>
                            </div>
                          </div> 
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="hflip">
                            <label class="form-check-label" for="hflip">Horizontal Flip</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="vflip">
                            <label class="form-check-label" for="vflip">Vertical Flip </label>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="adjustflip()">Apply</button>
                        <!-- End of Line-->
                    </div>
                </div>
            </div>
            {% if settings_from_camera['AfMode'] or settings_from_camera['LensPosition'] or settings_from_camera['AfRange'] or settings_from_camera['AfSpeed'] %}
            <!-- ###### Auto Focus Settings ###### -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                        Auto Focus Settings
                    </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            {% if 'AfMode' in settings_from_camera %}
                            <!-- AfMode -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">Auto Focus Mode</strong>
                                    <a data-bs-toggle="collapse" href="#AfMode_info" role="button" aria-expanded="false" aria-controls="collapseExample">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="AfMode_info">
                                <div class="card card-body">
                                        <strong class="mb-1">Manual</strong>
                                        <p class="mb-0">manually set the focus by adjusting the lens position below</p>
                                        <strong class="mb-1">Auto</strong>
                                        <p class="mb-0">auto focus once when 'Auto' is selected</p>
                                        <strong class="mb-1">Continuous</strong>
                                        <p class="mb-0">continuously auto focus without user interaction</p>
                                </div>
                              </div> 
                            <div class="form-check">
                                <input class="form-check-input AfMode" type="checkbox" name="AfMode" id="AfMode0" value="manual" onclick="showContent('#LensPosition_setting'); adjustCheckboxSetting('AfMode', '0')">
                                <label class="form-check-label" for="AfMode0">Manual</label>
                            </div>
                            {% if 'LensPosition' in settings_from_camera %}
                            <!-- LensPosition -->
                            <div class="collapse p-2" id="LensPosition_setting">
                                <div class="card card-body">
                                    <div class="form-group" id="LensPositionContainer">
                                        <label for="LensPosition" class="form-label mb-0" id="currentLensPosition">Lens Position:</label>
                                        <input type="range" class="form-range" min="0.0" max="10.0" step="0.1" id="LensPosition" onchange="adjustSliderSetting('LensPosition', this.value)">
                                        <div class="form-text" id="basic-addon4">In dioptres (1 / distance in metres)</div>
                                    </div>
                                </div>
                              </div> 
                            {% endif %}
                            <div class="form-check">
                                <input class="form-check-input AfMode" type="checkbox" name="AfMode" id="AfMode1" value="auto" onclick="hideContent('#LensPosition_setting'); adjustCheckboxSetting('AfMode', '1')">
                                <label class="form-check-label" for="AfMode1">Auto</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input AfMode" type="checkbox" name="AfMode" id="AfMode2" value="continuous" onclick="hideContent('#LensPosition_setting'); adjustCheckboxSetting('AfMode', '2')">
                                <label class="form-check-label" for="AfMode2">Continuous</label>
                            </div>
                            <hr>
                            {% endif %}
                            {% if 'AfRange' in settings_from_camera %}
                            <!-- AfRange -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">Auto Focus Range</strong>
                                    <a data-bs-toggle="collapse" href="#AfRange_info" role="button" aria-expanded="false" aria-controls="collapseExample">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="AfRange_info">
                                <div class="card card-body">
                                        <p class="mb-0">Range of lens positions to search.</p>
                                        <strong class="mb-1">Normal</strong>
                                        <p class="mb-0">search the normal range (may exclude very closest objects)</p>
                                        <strong class="mb-1">Macro</strong>
                                        <p class="mb-0">search only the closest part of the range</p>
                                        <strong class="mb-1">Full</strong>
                                        <p class="mb-0">search everything</p>
                                </div>
                              </div> 
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AfRange" id="AfRange0" onclick="adjustCheckboxSetting('AfRange', '0')">
                                <label class="form-check-label" for="AfRange0">Normal</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AfRange" id="AfRange1" onclick="adjustCheckboxSetting('AfRange','1')">
                                <label class="form-check-label" for="AfRange1">Macro</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AfRange" id="AfRange2" onclick="adjustCheckboxSetting('AfRange','2')">
                                <label class="form-check-label" for="AfRange2">Full</label>
                            </div>
                            <hr>
                            {% endif %}
                            {% if 'AfSpeed' in settings_from_camera %}
                            <!-- AfSpeed -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">Auto Focus Speed</strong>
                                    <a data-bs-toggle="collapse" href="#AfSpeed_info" role="button" aria-expanded="false" aria-controls="collapseExample">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="AfSpeed_info">
                                <div class="card card-body">
                                        <p class="mb-0">Speed of the autofocus search.</p>
                                        <strong class="mb-1">Normal</strong>
                                        <p class="mb-0">normal speed</p>
                                        <strong class="mb-1">Fast</strong>
                                        <p class="mb-0">try to move more quickly</p>
                                </div>
                              </div> 
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AfSpeed" id="AfSpeed0" onclick="adjustCheckboxSetting('AfSpeed','0')">
                                <label class="form-check-label" for="AfSpeed0">Normal</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AfSpeed" id="AfSpeed1" onclick="adjustCheckboxSetting('AfSpeed','1')">
                                <label class="form-check-label" for="AfRange1">Fast</label>
                            </div>
                            {% endif %}
                            <!-- End of Line-->
                        </div>
                    </div>
                </div>
                {% endif %}

            {% if settings_from_camera['AeEnable'] or settings_from_camera['AeConstraintMode'] or settings_from_camera['AeExposureMode'] or settings_from_camera['AeFlickerMode'] or settings_from_camera['AeFlickerPeriod'] or settings_from_camera['AeMeteringMode'] or settings_from_camera['ExposureTime'] or settings_from_camera['ExposureValue'] %}
            <!-- ###### Gain and Exposure Settings ###### -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            Gain and Exposure Settings
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            {% if 'ExposureValue' in settings_from_camera %}
                            <!-- ExposureValue -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">Exposure Compensation</strong>
                                    <a data-bs-toggle="collapse" href="#ExposureValue_info" role="button">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="ExposureValue_info">
                                <div class="card card-body">
                                        <p class="mb-0">Exposure compensation value in "stops", which adjusts the target of the AEC/AGC algorithm.</p>
                                        <p class="mb-0"> Positive values increase the target brightness, and negative values decrease it.</p> 
                                        <p class="mb-0">Zero represents the base or "normal" exposure level.</p>
                                </div>
                              </div> 
                            <div class="form-group">
                                <label for="ExposureValue" class="form-label mb-0" id="currentExposureValue">Value:</label>
                                <input type="range" class="form-range" min="-8.0" max="8.0" step="0.1" id="ExposureValue" onchange="adjustSliderSetting('ExposureValue', this.value)">
                            </div>
                            <hr>
                            {% endif %}
                            {% if 'ExposureTime' in settings_from_camera %}
                            <!-- ExposureTime -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">Exposure Time</strong>
                                    <a data-bs-toggle="collapse" href="#ExposureTime_info" role="button">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="ExposureTime_info">
                                <div class="card card-body">
                                        <p class="mb-0">Exposure time for the sensor to use, measured in microseconds.</p>
                                </div>
                              </div> 
                            <div class="input-group has-validation mb-3 p-2">
                                <div class="form-floating">
                                    <input type="number" class="form-control" placeholder="" aria-label="" aria-describedby="button-addon2" id="ExposureTime">
                                    <label for="floatingInputValue">Value in microseconds</label>
                                </div>
                                <button class="btn btn-outline-secondary" type="button" id="button-ExposureTime" onclick="adjustNumericSetting('ExposureTime')">Set</button>
                            </div> 
                            <div class="form-text" id="ExposureTimeRange"></div>                         
                            <hr>
                            {% endif %}
                            {% if 'AnalogueGain' in settings_from_camera %}
                            <!-- AnalogueGain -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">Analogue Gain</strong>
                                    <a data-bs-toggle="collapse" href="#AnalogueGain_info" role="button">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="AnalogueGain_info">
                                <div class="card card-body">
                                        <p class="mb-0">Analogue gain applied by the sensor</p>
                                </div>
                              </div> 
                            <div class="form-group">
                                <label for="AnalogueGain" class="form-label mb-0" id="currentAnalogueGain">Value:</label>
                                <input type="range" class="form-range" min="-8.0" max="8.0" step="0.1" id="AnalogueGain" onchange="adjustSliderSetting('AnalogueGain', this.value)">
                            </div>
                            <hr>
                            {% endif %}

                            {% if 'AeEnable' in settings_from_camera %}
                            <!-- AeEnable -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">Enable Changes to AEC/AGC algorithm</strong>
                                    <a data-bs-toggle="collapse" href="#AeEnable_info" role="button">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="AeEnable_info">
                                <div class="card card-body">
                                        <p class="mb-0">Allow the Auto Exposure Compensation and Auto Gain Compensation (AEC/AGC) algorithm to be turned on and off.</p>
                                        <p class="mb-0">When if is off, there will be no automatic updates to the cameraâ€™s gain or exposure settings.</p>
                                </div>
                              </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="AeEnable" data-bs-toggle="collapse" href="#AeEnable_setting" onchange="adjustSwitchSetting('AeEnable')">
                                <label class="form-check-label" for="AeEnable">Disabled/Enabled</label>
                            </div>
                            <div class="collapse p-2" id="AeEnable_setting">
                                <div>
                                    <p class="mb-0"></p>
                                    {% if 'AeConstraintMode' in settings_from_camera %}
                            <!-- AeConstraintMode -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">AE Constraint Mode</strong>
                                    <a data-bs-toggle="collapse" href="#AeConstraintMode_info" role="button" aria-expanded="false" aria-controls="collapseExample">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="AeConstraintMode_info">
                                <div class="card card-body">
                                        <p class="mb-0">Sets the constraint mode of the AEC/AGC algorithm.</p>
                                        <strong class="mb-1">Normal</strong>
                                        <p class="mb-0">normal metering</p>
                                        <strong class="mb-1">Highlight</strong>
                                        <p class="mb-0">meter for highlights</p>
                                        <strong class="mb-1">Shadows</strong>
                                        <p class="mb-0">meter for shadows</p>
                                        <strong class="mb-1">Custom</strong>
                                        <p class="mb-0">user-defined metering</p>
                                        <div class="alert alert-warning" role="alert">
                                            Shadows and Custom are currently disabled and requires more work
                                        </div>
                                </div>
                              </div> 
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeConstraintMode" id="AeConstraintMode0" onclick="adjustCheckboxSetting('AeConstraintMode', '0')">
                                <label class="form-check-label" for="AeConstraintMode0">Normal</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeConstraintMode" id="AeConstraintMode1" onclick="adjustCheckboxSetting('AeConstraintMode', '1')">
                                <label class="form-check-label" for="AeConstraintMode1">Highlight</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeConstraintMode" id="AeConstraintMode2" onclick="adjustCheckboxSetting('AeConstraintMode', '2')" disabled>
                                <label class="form-check-label" for="AeConstraintMode2">Shadows</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeConstraintMode" id="AeConstraintMode3" onclick="adjustCheckboxSetting('AeConstraintMode', '3')" disabled>
                                <label class="form-check-label" for="AeConstraintMode3">Custom</label>
                            </div>
                            <hr>
                            {% endif %}
                            {% if 'AeExposureMode' in settings_from_camera %}
                            <!-- AeExposureMode -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">AE Exposure Mode</strong>
                                    <a data-bs-toggle="collapse" href="#AeExposureMode_info" role="button" aria-expanded="false" aria-controls="collapseExample">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="AeExposureMode_info">
                                <div class="card card-body">
                                        <p class="mb-0">Sets the exposure mode of the AEC/AGC algorithm</p>
                                        <strong class="mb-1">Normal</strong>
                                        <p class="mb-0">normal exposures</p>
                                        <strong class="mb-1">Short</strong>
                                        <p class="mb-0">use shorter exposures</p>
                                        <strong class="mb-1">Long</strong>
                                        <p class="mb-0">use longer exposures</p>
                                        <strong class="mb-1">Custom</strong>
                                        <p class="mb-0">use custom exposures</p>
                                        <div class="alert alert-warning" role="alert">
                                            Custom is currently disabled and requires more work
                                        </div>
                                </div>
                              </div> 
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeExposureMode" id="AeExposureMode0" onclick="adjustCheckboxSetting('AeExposureMode', '0')">
                                <label class="form-check-label" for="AeExposureMode0">Normal</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeExposureMode" id="AeExposureMode1" onclick="adjustCheckboxSetting('AeExposureMode', '1')">
                                <label class="form-check-label" for="AeExposureMode1">Short</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeExposureMode" id="AeExposureMode2" onclick="adjustCheckboxSetting('AeExposureMode', '2')">
                                <label class="form-check-label" for="AeExposureMode2">Long</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeExposureMode" id="AeExposureMode3" onclick="adjustCheckboxSetting('AeExposureMode', '3')" disabled>
                                <label class="form-check-label" for="AeExposureMode3">Custom</label>
                            </div>
                            <hr>
                            {% endif %}
                            {% if 'AeMeteringMode' in settings_from_camera %}
                            <!-- AeMeteringMode -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">AE Metering Mode</strong>
                                    <a data-bs-toggle="collapse" href="#AeMeteringMode_info" role="button" aria-expanded="false" aria-controls="collapseExample">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="AeMeteringMode_info">
                                <div class="card card-body">
                                        <p class="mb-0">Sets the metering mode of the AEC/AGC algorithm.</p>
                                        <strong class="mb-1">Centre Weighted</strong>
                                        <p class="mb-0">centre weighted metering</p>
                                        <strong class="mb-1">Spot</strong>
                                        <p class="mb-0">spot metering</p>
                                        <strong class="mb-1">Matrix</strong>
                                        <p class="mb-0">matrix metering</p>
                                        <strong class="mb-1">Custom</strong>
                                        <p class="mb-0">custom metering</p>
                                        <div class="alert alert-warning" role="alert">
                                            Custom is currently disabled and requires more work
                                        </div>
                                </div>
                              </div> 
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeMeteringMode" id="AeMeteringMode0" onclick="adjustCheckboxSetting('AeMeteringMode', '0')">
                                <label class="form-check-label" for="AeMeteringMode0">Centre Weighted</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeMeteringMode" id="AeMeteringMode1" onclick="adjustCheckboxSetting('AeMeteringMode', '1')">
                                <label class="form-check-label" for="AeMeteringMode1">Short</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeMeteringMode" id="AeMeteringMode2" onclick="adjustCheckboxSetting('AeMeteringMode', '2')">
                                <label class="form-check-label" for="AeMeteringMode2">Matrix</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeMeteringMode" id="AeMeteringMode3" onclick="adjustCheckboxSetting('AeMeteringMode', '3')" disabled>
                                <label class="form-check-label" for="AeMeteringMode3">Custom</label>
                            </div>
                            {% endif %}
                                </div>
                              </div>


                            <hr>
                            {% endif %}
                            
                            
                            {% if 'AeFlickerMode' in settings_from_camera %}
                            <!-- AeFlickerMode -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">AE Flicker Mode</strong>
                                    <a data-bs-toggle="collapse" href="#AeFlickerMode_info" role="button" aria-expanded="false" aria-controls="collapseExample">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="AeFlickerMode_info">
                                <div class="card card-body">
                                        <p class="mb-0">Sets the flicker avoidance mode of the AEC/AGC algorithm.</p>
                                        <strong class="mb-1">Off</strong>
                                        <p class="mb-0">no flicker avoidance</p>
                                        <strong class="mb-1">Manual</strong>
                                        <p class="mb-0">flicker is avoided with a period set below </p>
                                        <hr>
                                        <p class="mb-0">The period of the lighting cycle in microseconds.</p>
                                        <p class="mb-0">For example, for 50Hz mains lighting the flicker occurs at 100Hz, so the period would be 10000 microseconds.</p>

                                </div>
                              </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeFlickerMode" id="AeFlickerMode0" onclick="hideContent('#AeFlickerMode_setting'); adjustCheckboxSetting('AeFlickerMode', '0')">
                                <label class="form-check-label" for="AeFlickerMode0">Off</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AeFlickerMode" id="AeFlickerMode1" onclick="showContent('#AeFlickerMode_setting'); adjustCheckboxSetting('AeFlickerMode', '1')">
                                <label class="form-check-label" for="AeFlickerMode1">Manual</label>
                            </div>
                            {% if 'AeFlickerPeriod' in settings_from_camera %}
                            <!-- AeFlickerPeriod -->
                            <div class="collapse p-2" id="AeFlickerMode_setting">
                                <div class="card card-body">
                            <label for="AeFlickerPeriod" class="form-label mb-0">AE Flicker Period:</label>
                            <div class="input-group mb-3 has-validation ">
                                <div class="form-floating">
                                    <input type="number" class="form-control" placeholder="" aria-label="" aria-describedby="button-addon2" id="AeFlickerPeriod">
                                    <label for="floatingInputValue">Value in microseconds</label>
                                </div>
                                <button class="btn btn-outline-secondary" type="button" id="button-ExposureTime" onclick="adjustNumericSetting('AeFlickerPeriod')">Set</button>
                            </div>    
                            <div class="form-text" id="AeFlickerPeriodRange"></div>  
                        </div>
                    </div>       
                                 
                            {% endif %}

                            {% endif %}
                           
                            
                            <!-- End of Line-->
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if settings_from_camera['AwbEnable'] %}
            <!-- ###### Auto White Balance Settings ###### -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            Auto White Balance Settings
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            {% if 'AwbEnable' in settings_from_camera %}
                            <!-- AwbEnable -->
                            <div class="d-flex w-100 align-items-center justify-content-between">
                                <strong class="mb-1">Enable Auto White Balance algorithm</strong>
                                    <a data-bs-toggle="collapse" href="#AeEnable_info" role="button">
                                    <i class="bi bi-info-circle"></i></a>
                            </div>
                            <div class="collapse p-2" id="AeEnable_info">
                                <div class="card card-body">
                                        <p class="mb-0">Turn the auto white balance (AWB) algorithm on or off. When it is off, there will be no automatic updates to the colour gains.</p>
                                        <strong class="mb-1">Auto</strong>
                                        <p class="mb-0">Automatically sets white balance and keeps adjusting</p>
                                        <strong class="mb-1">Custom</strong>
                                        <p class="mb-0">set your own white balance value</p>
                                        <div class="alert alert-warning" role="alert">
                                            Custom is currently disabled and requires more work
                                        </div>
                                </div>
                              </div>
                              <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="AwbEnable" data-bs-toggle="collapse" href="#AwbEnable_setting" onchange="adjustSwitchSetting('AwbEnable')">
                                <label class="form-check-label" for="AwbEnable">Disable/Enabled</label>
                            </div>
                            {% if 'AwbMode' in settings_from_camera %}
                            <!-- AwbMode -->
                            <div class="collapse p-2" id="AwbEnable_setting">
                                <div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AwbMode" id="AwbMode0" onclick="adjustCheckboxSetting('AwbMode', '0')">
                                <label class="form-check-label" for="AwbMode0">Auto</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AwbMode" id="AwbMode1" onclick="adjustCheckboxSetting('AwbMode', '1')">
                                <label class="form-check-label" for="AwbMode1">Tungsten</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AwbMode" id="AwbMode2" onclick="adjustCheckboxSetting('AwbMode', '2')">
                                <label class="form-check-label" for="AwbMode2">Fluorescent</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AwbMode" id="AwbMode3" onclick="adjustCheckboxSetting('AwbMode', '3')">
                                <label class="form-check-label" for="AwbMode3">Indoor</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AwbMode" id="AwbMode4" onclick="adjustCheckboxSetting('AwbMode', '4')">
                                <label class="form-check-label" for="AwbMode4">Daylight</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AwbMode" id="AwbMode5" onclick="adjustCheckboxSetting('AwbMode', '5')">
                                <label class="form-check-label" for="AwbMode5">Cloudy</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="AwbMode" id="AwbMode6" onclick="adjustCheckboxSetting('AwbMode', '6')" disabled>
                                <label class="form-check-label" for="AwbMode6">Custom</label>
                            </div>
                            </div>
                            </div>
                            {% endif %}
                            {% endif %}
                            <!-- End of Line-->
                        </div>
                    </div>
                </div>
                {% endif %}

            <!-- ###### Brightness & Contrast Settings ###### -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                        Brightness & Contrast Settings
                        </button>
                    </h2>
                    <div id="collapseFour" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <!-- Brightness -->
                            <div class="form-group">
                                <div class="d-flex w-100 align-items-center justify-content-between">
                                    <strong class="mb-1"><label for="brightness" class="form-label mb-0" id="currentBrightness">Brightness:</label></strong>
                                        <a data-bs-toggle="collapse" href="#brightness_info" role="button">
                                        <i class="bi bi-info-circle"></i></a>
                                </div>
                                <div class="collapse p-2" id="brightness_info">
                                    <div class="card card-body">
                                            <p class="mb-0">Adjusts the image brightness where -1.0 is very dark, 1.0 is very bright, and 0.0 is the default "normal" brightness.</p>
                                    </div>
                                  </div>
                                
                                <input type="range" class="form-range" min="-1.0" max="1.0" step="0.1" id="Brightness" onchange="adjustSliderSetting('Brightness', this.value)">
                            </div>
                            <hr>
                            <!-- Contrast -->
                            <div class="form-group">
                                <div class="d-flex w-100 align-items-center justify-content-between">
                                    <strong class="mb-1"><label for="contrast" class="form-label mb-0" id="currentContrast">Contrast:</label></strong>
                                        <a data-bs-toggle="collapse" href="#contrast_info" role="button">
                                        <i class="bi bi-info-circle"></i></a>
                                </div>
                                <div class="collapse p-2" id="contrast_info">
                                    <div class="card card-body">
                                            <p class="mb-0">Sets the contrast of the image, where zero means "no contrast", 1.0 is the default "normal" contrast, and larger values increase the contrast proportionately</p>
                                    </div>
                                  </div>
                                <input type="range" class="form-range" min="0.0" max="32.0" step="0.1" id="Contrast" onchange="adjustSliderSetting('Contrast', this.value)">
                            </div>
                            <hr>
                            <!-- Saturation -->
                            <div class="form-group">
                                <div class="d-flex w-100 align-items-center justify-content-between">
                                    <strong class="mb-1"><label for="saturation" class="form-label mb-0" id="currentSaturation">Saturation:</label></strong>
                                        <a data-bs-toggle="collapse" href="#saturation_info" role="button">
                                        <i class="bi bi-info-circle"></i></a>
                                </div>
                                <div class="collapse p-2" id="saturation_info">
                                    <div class="card card-body">
                                            <p class="mb-0">Amount of colour saturation, where zero produces greyscale images, 1.0 represents default "normal" saturation, and higher values produce more saturated colours.</p>
                                    </div>
                                  </div>
                                
                                <input type="range" class="form-range" min="0.0" max="32.0" step="0.1" id="Saturation" onchange="adjustSliderSetting('Saturation', this.value)">
                            </div>
                            <hr>
                            <!-- Sharpness -->
                            <div class="form-group">
                                <div class="d-flex w-100 align-items-center justify-content-between">
                                    <strong class="mb-1"><label for="sharpness" class="form-label mb-0" id="currentSharpness">Sharpness:</label></strong>
                                        <a data-bs-toggle="collapse" href="#sharpness_info" role="button">
                                        <i class="bi bi-info-circle"></i></a>
                                </div>
                                <div class="collapse p-2" id="sharpness_info">
                                    <div class="card card-body">
                                            <p class="mb-0">Sets the image sharpness, where zero implies no additional sharpening is performed, 1.0 is the default "normal" level of sharpening, and larger values apply proportionately stronger sharpening.</p>
                                    </div>
                                  </div>
                                
                                <input type="range" class="form-range" min="0.0" max="16.0" step="0.1" id="Sharpness" onchange="adjustSliderSetting('Sharpness', this.value)">
                            </div>
                            <!-- End of Line-->
                        </div>
                    </div>
                </div>


                <!-- ###### ScalerCrop Settings ###### 
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                            Scaler Crop Settings
                        </button>
                    </h2>
                    <div id="collapseFive" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                        <div class="accordion-body"> -->
                            <!-- ScalerCrop --><!-- 
                            <style>
                                #cameraFrame {
                                   width: 242px; /* Set a smaller width */
                                   height: 135px; /* Set a smaller height */
                                }

                                 #cropFrame {
                                    position: absolute;
                                }

                                input {
                                    width: 50px;
                                }
                            </style>
                            <div class="border border-primary card" id="cameraFrame">
                                <div class="border border-danger card" id="cropFrame"></div>
                            </div>
                            <label for="ScalerCrop" class="form-label mb-0">Size of Crop</label>
                            <div class="input-group mb-3 has-validation">
                                <div class="form-floating">
                                    <input type="number" class="form-control" placeholder="" aria-label="width" id="ScalerCropWidth">
                                    <label for="floatingInputValue">Width in px</label>
                                </div>
                                <div class="form-floating">
                                    <input type="number" class="form-control" placeholder="" aria-label="height" id="ScalerCropHeight">
                                    <label for="floatingInputValue">Height in px</label>
                                </div>
                            </div>
                            <label for="ScalerCrop" class="form-label mb-0">Offset</label>
                            <div class="input-group mb-3 has-validation">
                                <div class="form-floating">
                                    <input type="number" class="form-control" placeholder="" aria-label="xOffset" id="ScalerCropXOffset">
                                    <label for="floatingInputValue">X Offset</label>
                                </div>
                                <div class="form-floating">
                                    <input type="number" class="form-control" placeholder="" aria-label="yOffset" id="ScalerCropYOffset">
                                    <label for="floatingInputValue">Y Offset</label>
                                </div>
                            </div>
                            <button class="btn btn-outline-secondary" type="button" id="button-ExposureTime" onclick="adjustScalerCrop()">Set</button>
                        -->
                            <!-- End of Line--><!-- 
                        </div>
                    </div>
                </div> -->
                            <!-- ###### Camera Capture Settings ###### -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSix" aria-expanded="false" aria-controls="collapseSix">
                                            Camera Capture Settings
                                        </button>
                                    </h2>
                                    <div id="collapseSix" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                                        <div class="accordion-body">
                                            <!-- Resolution -->
                                            <div class="d-flex w-100 align-items-center justify-content-between">
                                                <strong class="mb-1"><label for="capture" class="form-label mb-0" id="currentCapture">Select Feed/Capture Resolution:</label></strong>
                                                    <a data-bs-toggle="collapse" href="#capture_info" role="button">
                                                    <i class="bi bi-info-circle"></i></a>
                                            </div>
                                            <div class="collapse p-2" id="capture_info">
                                                <div class="card card-body">
                                                        <p class="mb-0">Capture resolution is a up or downscaling of the feed from the camera module. If you wish to change the source resoltuion you need to goto Camera Info and change the sensor mode.</p>
                                                </div>
                                              </div>
                                            {% for i, resolution in enumerate(resolutions) %}
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="Resolution" id="Resolution{{ i }}" onclick="adjustResolution('Resolution', '{{ i }}',{{ resolution[0] }}, {{ resolution[1] }})">
                                                <label class="form-check-label" for="Resolution{{ i }}">{{ resolution[0] }}x{{ resolution[1] }}</label>
                                            </div>
                                            {% endfor %}
                                        <hr></hr>
                                            <!-- Make Raw -->
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" role="switch" id="makeRaw" onchange="adjustSwitchSetting('makeRaw')">
                                                <label for="makeRaw" >Enable: Save Raw Image</label>
                                            </div>
                                            <!-- End of Line-->
                                        </div>
                                    </div>
                                </div>
                       

            </div>
            <ul class="list-group pt-3">
                <li class="list-group-item active" aria-current="true">Settings Controls</li>
                <li class="list-group-item">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#configModal">
                        Load/Save Camera Settings
                    </button>
                 </li>
            </ul>
        </div>
        
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="configModalLabel">Load/Save Camera Settings</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-body">
                    <!-- Bootstrap Alert -->
                    <div class="alert alert-danger d-none" id="configAlert" role="alert"></div>

                    <div class="accordion" id="accordionLoadSave">
                        <div class="accordion-item">
                          <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLoadFile" aria-expanded="false" aria-controls="collapseLoadFile">
                              Load camera settings from file:
                            </button>
                          </h2>
                          <div id="collapseLoadFile" class="accordion-collapse collapse" data-bs-parent="#accordionLoadSave">
                            <div class="accordion-body">
                                <div class="form-group">
                                <table class="table" id="configTable">
                                    <thead>
                                        <tr>
                                            <th scope="col">Select</th>
                                            <th scope="col">Filename</th>
                                            <th scope="col">Model</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if config_data %}
                                            {% for i, config in enumerate(config_data) %}
                                                <tr>
                                                    <td>
                                                        <input type="radio" name="selectedConfig" value="{{ config.filename }}" data-model="{{ config.model }}" {% if config.is_selected %}checked{% endif %}>
                                                    </td>
                                                    <td>{{ config.filename }}</td>
                                                    <td>{{ config.model }}</td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="3">No configs saved</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                                <button type="button" class="btn btn-primary" onclick="loadConfigFile()">Load Selected Config</button>
                            </div>
                            </div>
                            </div>
                          </div>
                        <div class="accordion-item">
                          <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDefaultSystem" aria-expanded="false" aria-controls="collapseDefaultSystem">
                              Save current settings as new file:
                            </button>
                          </h2>
                          <div id="collapseDefaultSystem" class="accordion-collapse collapse" data-bs-parent="#accordionLoadSave">
                            <div class="accordion-body">
                                <p>Enter filename you wish to use:</p>
                    <div class="mb-3">
                        <div class="row">
                            <input type="text" class="form-control" id="saveConfigFile" placeholder="Enter filename" aria-label="filename" aria-describedby="save_filename">
                        </div>
                        <div class="row">
                            <div class="form-text">Using a filename that already exists will overwrite that file.</div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="save_config_file()">Submit</button>
                            </div>
                          </div>
                        </div>
                        <div class="accordion-item">
                          <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSaveFile" aria-expanded="false" aria-controls="collapseSaveFile">
                              Reset settings to camera default:
                            </button>
                          </h2>
                          <div id="collapseSaveFile" class="accordion-collapse collapse" data-bs-parent="#accordionLoadSave">
                            <div class="accordion-body">
                                <div class="d-flex w-100 justify-content-between">
                                    <p class="mb-1">Just checking, are you sure?</p>
                                  </div>
                                  <button type="button" class="btn btn-danger" onclick="reset_default_settings_camera()">Set Settings to Default</button>
                            </div>
                          </div>
                        </div>
                      </div>
            </div>
        </div>
    </div>
  </div>
</div>
  
  


<script>

document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM content loaded');

    // Parse the JSON string into a JavaScript object
    var liveSettings = {{ live_settings | tojson }};
    var rotationSettings = {{ rotation_settings | tojson }};
    var settings_from_camera = {{ settings_from_camera | tojson }};
    var capture_settings = {{ capture_settings | tojson }};
 

    console.log(liveSettings);
    console.log(capture_settings);
    // Call the updateUI

    setrange(settings_from_camera);
    updateUI(liveSettings);
    updateUI(rotationSettings);
    updateUI(capture_settings);
    console.log(capture_settings);

});

// Function to show/hide sections based on checkbox values
function toggleHiddenControls() {
            var controlMap = {
                'AfMode0': 'LensPosition_setting',
                'AeEnable': 'AeEnable_setting',
                'AeFlickerMode1':'AeFlickerMode_setting',
                'AwbEnable':'AwbEnable_setting'
                // Add more mappings as needed
            };

            for (var checkboxId in controlMap) {
                if (controlMap.hasOwnProperty(checkboxId)) {
                    var sectionId = controlMap[checkboxId];
                    var isChecked = $('#' + checkboxId).prop('checked');

                    if (isChecked) {
                        $('#' + sectionId).collapse('show');
                    } else {
                        $('#' + sectionId).collapse('hide');
                    }
                }
            }
        }

        // Initial state setup
        $(document).ready(function() {
            toggleHiddenControls();
        });

document.addEventListener('DOMContentLoaded', function () {
        // Get the image element
        const cameraImage = document.getElementById('cameraImage');

        // Set the source attribute to start loading the image
        
        cameraImage.src = "{{ url_for('video_feed', camera_num=camera_num) }}";
    });

document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            // Page is visible, reload the camera feed
            refreshCameraFeed();
        }
    });

    const checkboxSettings = ['AfMode', 'AfRange', 'AfSpeed', 'AeConstraintMode', 'AeExposureMode', 'AeFlickerMode', 'AeMeteringMode', 'AwbMode', 'Resolution'];
    const switchSettings = ['AwbEnable', 'AeEnable', 'AwbMode', 'hflip', 'vflip', 'makeRaw'];
    const sliderSettings = ['LensPosition', 'ExposureValue', 'Brightness', 'Contrast', 'Saturation', 'Sharpness', 'AnalogueGain'];
    const inputSettings = ['ExposureTime', 'AeFlickerPeriod']
    const camera_num = {{ camera_num }};
    const camera_info = {{ camera_info | tojson }};

function setrange(settings_from_camera) {
    for (const key in settings_from_camera) {
        const setting = settings_from_camera[key];
        //console.log(`${key} setting: ${setting}`);
        const min = setting[0];
        const max = setting[1];
        const defaultValue = setting[2]; 
        if (sliderSettings.includes(key)) {
                const elementId = document.getElementById(key);
                if (elementId) {
                    elementId.min = min;
                    elementId.max = max;
                    elementId.value = defaultValue;
                    const rangeElementId = document.getElementById(`current${key}`);
                    if (key === 'LensPosition') {
                        rangeElementId.innerHTML = `Lens Position: ${defaultValue}`;
                    } else if (key === 'ExposureValue' || key === 'AnalogueGain') {
                        rangeElementId.innerHTML = `Value: ${defaultValue}`;
                    } else {
                        rangeElementId.innerHTML = `${key}: ${defaultValue}`;
                    }  
                }
            } else if (inputSettings.includes(key)) {
                const elementId = document.getElementById(key);
                if (elementId) {
                    elementId.min = min;
                    elementId.max = max;
                    elementId.value = defaultValue;
                    const rangeElementId = document.getElementById(`${key}Range`);
                    rangeElementId.innerHTML = `Please enter a value between ${min} and ${max}`;
                }
            } else if (key === 'ScalerCrop') {
                //Scaler crop needs a little more config
                // Deal with width
                const width = document.getElementById(`${key}Width`);
                if (width) {
                    width.min = min[2];
                    width.max = max[2];
                    width.value = defaultValue[2];
                }
                // Deal with height
                const height = document.getElementById(`${key}Height`);
                if (height) {
                    height.min = min[3];
                    height.max = max[3];
                    height.value = defaultValue[3];
                }
                // Deal with x-offset
                const xOffset = document.getElementById(`${key}XOffset`);
                if (xOffset) {
                    xOffset.min = min[0];
                    xOffset.max = max[0];
                    xOffset.value = defaultValue[0];
                }
                // Deal with y-offset
                const yOffset = document.getElementById(`${key}YOffset`);
                if (yOffset) {
                    yOffset.min = min[1];
                    yOffset.max = max[1];
                    yOffset.value = defaultValue[1];
                }

                
            } else {
                console.log(`Skipping setting: ${key}`);
            }
    }
}

function showContent(id) {
        $(id).collapse('show');
    }

    function hideContent(id) {
        $(id).collapse('hide');
    }

function updateUI(settings) {
    console.log("Settings object:", settings);

    // Ensure settings is an object
    if (typeof settings !== 'object' || settings === null) {
        console.error("Invalid settings object");
        return;
    }
    for (const key in settings) {
        if (settings.hasOwnProperty(key)) {  // Check if the key is a direct property
            console.log("Key:", key, "Value:", settings[key]);}
        if (checkboxSettings.includes(key)) {
                console.log(settings[key]);
                console.log(settings);
                // Update checkboxes
                const checkboxes = document.getElementsByName(key);
                console.log(checkboxes);
                checkboxes.forEach(checkbox => {
                    const checkboxValue = parseInt(checkbox.id.replace(key, ''));
                    checkbox.checked = settings[key] === checkboxValue;
                });
                if (key === 'AfMode' && settings[key] === '0')  {
                    showContent();
                    slider.innerText = `Value: ${settings[key]}`;
                }
            } else if (switchSettings.includes(key)) {
                // Update the switch state
                const switchbox = document.getElementById(key);
                if (switchbox) {
                    switchbox.checked = settings[key];
                }
            } else if (sliderSettings.includes(key)) {
                document.getElementById(key).value = settings[key];
                const slider = document.getElementById(`current${key}`);
                if (key === 'LensPosition') {
                    slider.innerText = `Lens Position: ${settings[key]}`;
                } else if (key === 'ExposureValue' || key === 'AnalogueGain') {
                    slider.innerText = `Value: ${settings[key]}`;
                } else {
                    slider.innerText = `${key}: ${settings[key]}`; 
                }
            } else if (inputSettings.includes(key)) {
                const input = document.getElementById(key);
                if (input) {
                    input.value = settings[key];
                }
            } else if (key === 'ScalerCrop') {
                console.log(settings[key]);
                const cropFrame = document.getElementById('cropFrame');
                const x_offset = document.getElementById('ScalerCropXOffset');
                const y_offset = document.getElementById('ScalerCropYOffset');
                const width = document.getElementById('ScalerCropWidth');
                const height = document.getElementById('ScalerCropHeight');
                const maxFrameWidth = parseInt(document.getElementById('ScalerCropWidth').max);
                const maxFrameHeight = parseInt(document.getElementById('ScalerCropHeight').max);
                if (x_offset) {
                    x_offset.value = settings[key][0]
                    cropFrame.style.left = (settings[key][0] * 240 / maxFrameWidth) + 'px';
                } 
                if (y_offset) {
                    y_offset.value = settings[key][1]
                    cropFrame.style.top = (settings[key][1] * 133 / maxFrameHeight) + 'px';
                }
                if (width) {
                    width.value = settings[key][2]
                    cropFrame.style.width = (settings[key][2] * 240 / maxFrameWidth) + 'px';
                } 
                if (height) {
                    height.value = settings[key][3]
                    cropFrame.style.height = (settings[key][3] * 133 / maxFrameHeight) + 'px';
                }                
            } else {
                console.log(`Skipping unknown setting: ${key}`);
            }
    }
}

////////////////////////////////////
// Live Settings 

// Function to update server settings and UI
function updateLiveSettings(data) {
    console.log(data);
    return fetch('/update_live_settings_' + camera_num, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(data => {
        console.log('Settings updated:', data);
        // Return the data to the next chain
        return data;
    })
    .catch(error => {
        console.error('Error updating settings:', error);
        throw error;  // Re-throw the error for the next catch
    });
}

function adjustSwitchSetting(settingId) {
    // Get the current state of the switch
    const inputElement = document.getElementById(settingId);
    const selection = inputElement.checked;
    // Update server settings
    updateLiveSettings({ [settingId]: selection });
    // Notify console
    console.log(settingId, 'changed:', selection);
}

function adjustCheckboxSetting(settingId, selection) {
    // Convert settingValue to an integer
    const settingValue = parseInt(selection);

    // Update UI with the new value
    updateUI({ [settingId]: settingValue });

    // Update server settings and return the promise
    return updateLiveSettings({ [settingId]: settingValue })
        .then(() => {
            // Notify console
            console.log(settingId, 'changed:', settingValue);
        });
}

function adjustSliderSetting(settingId, selection) {
    // Convert settingValue to an float
    const settingValue = parseFloat(selection);
    // Update UI with the new value
    updateUI({ [settingId]: settingValue });
    // Update server settings
    updateLiveSettings({ [settingId]: settingValue });
    // Notify console
    console.log(settingId, 'changed:', settingValue);
}

function adjustNumericSetting(settingId) {
    // Handle the input change here
    const inputElement = document.getElementById(settingId);
    const setValue = parseFloat(inputElement.value); // Convert to a number
    // Get the min and max values from the input element
    const minValue = parseFloat(inputElement.min);
    const maxValue = parseFloat(inputElement.max);
    // Check if the entered value is within the valid range
    if (setValue < minValue || setValue > maxValue || isNaN(setValue)) {
        // Add 'invalid' class to the input element
        inputElement.classList.add('is-invalid');
    } else {
        // Remove 'invalid' class and error message div if they exist
        inputElement.classList.remove('is-invalid');
        // Update UI and server settings
        updateUI({ [settingId]: setValue });
        updateLiveSettings({ [settingId]: setValue });
    }
}

function adjustScalerCrop() {
            const x_offset = parseInt(document.getElementById('ScalerCropXOffset').value);
            const y_offset = parseInt(document.getElementById('ScalerCropYOffset').value);
            let width = parseInt(document.getElementById('ScalerCropWidth').value);
            let height = parseInt(document.getElementById('ScalerCropHeight').value);
            
            const maxFrameWidth = parseInt(document.getElementById('ScalerCropWidth').max); // Maximum width of the cameraFrame
            const maxFrameHeight = parseInt(document.getElementById('ScalerCropHeight').max); // Maximum height of the cameraFrame
            const minFrameWidth = parseInt(document.getElementById('ScalerCropWidth').min); // Minimum width of the cameraFrame
            const minFrameHeight = parseInt(document.getElementById('ScalerCropHeight').min); // Minimum height of the cameraFrame
    
            // Adjust width if needed
            if (width < minFrameWidth) {
                width = minFrameWidth;
                document.getElementById('ScalerCropWidth').value = width;
            }
            if (x_offset + width > maxFrameWidth) {
                width = maxFrameWidth - x_offset;
                document.getElementById('ScalerCropWidth').value = width;
            }
    
            // Adjust height if needed
            if (height < minFrameHeight) {
                height = minFrameHeight;
                document.getElementById('ScalerCropHeight').value = height;
            }
            if (y_offset + height > maxFrameHeight) {
                height = maxFrameHeight - y_offset;
                document.getElementById('ScalerCropHeight').value = height;
            }
    
            const cropFrame = document.getElementById('cropFrame');
            cropFrame.style.left = (x_offset * 240 / maxFrameWidth) + 'px';
            cropFrame.style.top = (y_offset * 133 / maxFrameHeight) + 'px';
            cropFrame.style.width = (width * 240 / maxFrameWidth) + 'px';
            cropFrame.style.height = (height * 133 / maxFrameHeight) + 'px';
            console.log(`ScalerCrop: [${x_offset}, ${y_offset}, ${width}, ${height}]`);
            updateLiveSettings({'ScalerCrop':[x_offset, y_offset, width, height]})
}

// JavaScript to handle the radio button selection logic
document.querySelectorAll('input[name="selectedConfig"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        if (this.id === 'defaultConfig' || this.id === 'saveNewConfig') {
            document.querySelectorAll('input[name="selectedConfig"]').forEach(function(otherRadio) {
                if (otherRadio !== radio) {
                    otherRadio.checked = false;
                }
            });
        }
    });
});

function loadConfigFile() {
    const selectedConfig = document.querySelector('input[name="selectedConfig"]:checked');
    const alertBox = document.getElementById('configAlert');
    const configModal = document.getElementById('configModal');

    if (selectedConfig) {
        const selectedModel = selectedConfig.getAttribute('data-model');
        const filename = selectedConfig.getAttribute('value');

        if (selectedModel && selectedModel !== camera_info['Model']) {
            alertBox.textContent = 'Cannot load config for another camera model.';
            alertBox.classList.remove('d-none');
            console.log('Cannot load config for another camera model.');
            return;
        } else {
            fetch(`/get_file_settings_camera_${camera_num}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ filename: filename }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alertBox.classList.add('d-none');
                    console.log('Config loaded successfully:', data);
                    
                    const live_settings = data.live_settings;
                    const restart_settings = data.rotation_settings;
                    const capture_settings = data.capture_settings;
                    const resolutions = data.resolutions;

                    updateUI(live_settings);
                    updateUI(restart_settings);
                    updateUI(capture_settings);
                    refreshCameraFeed();

                    // Close the modal
                    const modalInstance = bootstrap.Modal.getInstance(configModal);
                    modalInstance.hide();
                } else {
                    alertBox.textContent = `Error: ${data.error}`;
                    alertBox.classList.remove('d-none');
                    console.error('Error loading config:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading config:', error);
                alertBox.textContent = `Error: ${error.message}`;
                alertBox.classList.remove('d-none');
            });
        }
    }
}
 
function save_config_file() {
    const newFilename = document.getElementById('saveConfigFile').value;
    const alertBox = document.getElementById('configAlert');
    const configModal = document.getElementById('configModal');
    
    if (!newFilename.trim()) {
        alertBox.textContent = 'Please enter a filename to save the new config.';
        alertBox.classList.remove('d-none');
        console.log('Please enter a filename to save the new config.');
        return;
    } else {
        fetch('/save_config_file_camera_' + camera_num, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ filename: newFilename }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alertBox.classList.add('d-none');
                console.log('Saving was successful:', data);
                
                // Check if the filename already exists in the table
                const existingRow = document.querySelector(`#configTable tbody tr td:first-child input[value="${data.filename}"]`);
                
                if (!existingRow) {
                    // If the filename does not exist, add it to the table
                    addConfigToTable(data.filename, data.model);
                } else {
                    // If the filename exists, select the existing row
                    existingRow.checked = true;
                    
                    // Uncheck all other radio buttons
                    const radioButtons = document.querySelectorAll('#configTable tbody input[name="selectedConfig"]');
                    radioButtons.forEach(radio => {
                        if (radio.value !== data.filename) {
                            radio.checked = false;
                        }
                    });
                }

                // Close the modal
                const modalInstance = bootstrap.Modal.getInstance(configModal);
                modalInstance.hide();
            } else {
                alertBox.textContent = `Error: ${data.error}`;
                alertBox.classList.remove('d-none');
                console.error('Error updating settings:', data.error);
            }
        })
        .catch(error => {
            console.error('Error updating settings:', error);
            alertBox.textContent = `Error: ${error.message}`;
            alertBox.classList.remove('d-none');
        });
    }
}

function addConfigToTable(filename, model) {
    const tableBody = document.querySelector('#configTable tbody');
    const newRow = document.createElement('tr');
    
    newRow.innerHTML = `
        <td><input type="radio" name="selectedConfig" value="${filename}" data-model="${model}" checked></td>
        <td>${filename}</td>
        <td>${model}</td>
    `;
    
    // Append the new row to the table body
    tableBody.appendChild(newRow);

    // Uncheck all other radio buttons
    const radioButtons = tableBody.querySelectorAll('input[name="selectedConfig"]');
    radioButtons.forEach(radio => {
        if (radio.value !== filename) {
            radio.checked = false;
        }
    });
}

function get_file_settings_camera(data) {
    console.log(data);
    return fetch('/get_file_settings_camera_' + camera_num, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(data => {
        console.log('Settings updated:', data);
        const live_settings = data.live_settings;
        const restart_settings = data.rotation_settings;
        const capture_settings = data.capture_settings;
        const resolutions = data.resolutions;

        console.log(capture_settings)
        console.log(resolutions)
        // Update UI with live_settings
        updateUI(live_settings);
        updateUI(restart_settings);
        updateUI(capture_settings);
        refreshCameraFeed();
        return data;
    })
    .catch(error => {
        console.error('Error updating settings:', error);
        throw error;  // Re-throw the error for the next catch
    });
}

// Placeholder function for the save button
function saveConfig() {
    const selectedConfig = document.querySelector('input[name="selectedConfig"]:checked').value;
    const newFilename = document.getElementById('saveConfigFile').value;

    // Implement the logic for saving/loading configs here
    console.log('Selected Config:', selectedConfig);
    console.log('New Filename:', newFilename);
    
}

// Function to update server settings and UI
function reset_default_settings_camera() {
        fetch('/reset_default_settings_camera_' + camera_num)
            .then(response => response.json())
            .then(data => {
        console.log('Settings received:', data);

        // Access live_settings and restart_settings
        const live_settings = data.live_settings;
        const restart_settings = data.rotation_settings;

        console.log('Data 1:', live_settings);
        console.log('Data 2:', restart_settings);
        // Update UI with live_settings
        updateUI(live_settings);
        updateUI(restart_settings);
        refreshCameraFeed();
        // Close the modal
        const modalInstance = bootstrap.Modal.getInstance(configModal);
        modalInstance.hide();
    })
    .catch(error => {
        console.error('Error updating settings:', error);
        throw error;  // Re-throw the error for the next catch
    });
}

function saveSettings() {
    fetch('/save_settings', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        console.log('Settings saved:', data);
        // You can display a message or update the UI as needed
    })
    .catch(error => {
        console.error('Error saving settings:', error);
        // Handle the error
    });
}

////////////////////////////////////
// Take a Picture functions

let captureButton = document.getElementById('captureButton');
let isButtonEnabled = true;

function enableCaptureButton() {
    isButtonEnabled = true;
    captureButton.disabled = false;
}

function enablestoptimelapseButton() {
    isButtonEnabled = true;
    stoptimelapseButton.disabled = false;
}

function enablestarttimelapseButton() {
    isButtonEnabled = true;
    starttimelapseButton.disabled = false;
}

function capturePhoto() {
    if (!isButtonEnabled) {
        return;
    }

    // Disable the button to prevent rapid presses
    captureButton.disabled = true;
    isButtonEnabled = false;
    // Show alert based on the condition
    const alertElement = document.getElementById('captureAlert');

    // Call your capture_photo function here
    fetch('/capture_photo_'+ camera_num, {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        // Handle the success response here
        console.log(data);

        // Re-enable the button after a successful response
        enableCaptureButton();
        // Success alert
        alertElement.className = 'alert alert-success';
        alertElement.textContent = 'Image saved successfully.';
    })
    .catch(error => {
        // Handle the error response here
        console.error('Error capturing photo:', error);
        // Error alert
        alertElement.className = 'alert alert-danger';
        alertElement.textContent = 'Error capturing photo.';
        // Re-enable the button in case of an error
        enableCaptureButton();
    });
    alertElement.style.display = 'block';

    // Optional: Hide the alert after a few seconds
    setTimeout(() => {
        alertElement.style.display = 'none';
    }, 5000); // Adjust the time as needed
}

function stop_timelapse() {
    if (!isButtonEnabled) {
        return;
    }

    // Disable the button to prevent rapid presses
    stoptimelapseButton.disabled = true;
    isButtonEnabled = false;
    // Show alert based on the condition
    const alertElement = document.getElementById('captureAlert');

    // Call your capture_photo function here
    fetch('/stop_timelapse', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        // Handle the success response here
        console.log(data);

        // Re-enable the button after a successful response
        enablestoptimelapseButton();
        // Success alert
        alertElement.className = 'alert alert-success';
        alertElement.textContent = 'Timelapse stopped succesfully.';
    })
    .catch(error => {
        // Handle the error response here
        console.error('Error capturing photo:', error);
        // Error alert
        alertElement.className = 'alert alert-danger';
        alertElement.textContent = 'Error capturing photo.';
        // Re-enable the button in case of an error
        enablestoptimelapseButton();
    });
    alertElement.style.display = 'block';

    // Optional: Hide the alert after a few seconds
    setTimeout(() => {
        alertElement.style.display = 'none';
    }, 5000); // Adjust the time as needed
}

function start_timelapse() {
    if (!isButtonEnabled) {
        return;
    }

    // Disable the button to prevent rapid presses
    starttimelapseButton.disabled = true;
    isButtonEnabled = false;
    // Show alert based on the condition
    const alertElement = document.getElementById('captureAlert');

    // Call your capture_photo function here
    fetch('/start_timelapse', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        // Handle the success response here
        console.log(data);

        // Re-enable the button after a successful response
        enablestarttimelapseButton();
        // Success alert
        alertElement.className = 'alert alert-sucess';
        alertElement.textContent = 'Timelapse Started.';
    })
    .catch(error => {
        // Handle the error response here
        console.error('Error starting timelapse:', error);
        // Error alert
        alertElement.className = 'alert alert-danger';
        alertElement.textContent = 'Error starting timelapse.';
        // Re-enable the button in case of an error
        enablestarttimelapseButton();
    });
    alertElement.style.display = 'block';

    // Optional: Hide the alert after a few seconds
    setTimeout(() => {
        alertElement.style.display = 'none';
    }, 5000); // Adjust the time as needed
}


////////////////////////////////////
// Feed Restarting Settings 
// Function to update server settings and UI
function updateRestartSettings(data) {
    return fetch('/update_restart_settings_' + camera_num, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
    })
    .then(response => response.json())
    .then(data => {
        console.log('Settings updated:', data);
        // Update UI with the new settings
        // updateUI(data);
        // Return the data to the next chain
        return data;
    })
    .catch(error => {
        console.error('Error updating settings:', error);
        throw error;  // Re-throw the error for the next catch
    });
}

function resizeImageElement(fullResolutionWidth, fullResolutionHeight) {
  const imageElement = document.getElementById('cameraImage');
  if (imageElement) {
    // Set the width to the full resolution width
    imageElement.style.width = `${fullResolutionWidth}px`;
    // Calculate the height based on the aspect ratio and set it

    cameraImage.src = `${cameraImage.src.split('?')[0]}?${new Date().getTime()}`;
  }
}

// Function to refresh the camera feed
function refreshCameraFeed() {
  const imageElement = document.getElementById('cameraImage');
  if (imageElement) {
    // Get the full resolution of the image
    const fullResolutionWidth = imageElement.naturalWidth;
    const fullResolutionHeight = imageElement.naturalHeight;

    // Calculate the aspect ratio
    const aspectRatio = fullResolutionWidth / fullResolutionHeight;

    // Set the width to 100% and calculate the height based on the aspect ratio
    imageElement.style.width = '100%';
    imageElement.style.height = `${imageElement.offsetWidth / aspectRatio}px`;
    cameraImage.src = `${cameraImage.src.split('?')[0]}?${new Date().getTime()}`;

  }
}

function adjustResolution(settingId, selection, fullResolutionWidth, fullResolutionHeight) {
    // Call adjustCheckboxSetting
    adjustCheckboxSetting(settingId, selection)
        .then(() => {
            // The asynchronous part is done, now you can perform other tasks
            resizeImageElement(fullResolutionWidth, fullResolutionHeight);
            
        })
        .catch(error => {
            console.error('Error updating server settings:', error);
            // Handle the error if needed
        });
}




function adjustflip(mode) {
    // Convert mode to an integer
    const hflipswitch = document.getElementById('hflip');
    const hflipValue = hflipswitch.checked ? 1 : 0;  // Convert true to 1, false to 0
    const vflipswitch = document.getElementById('vflip');
    const vflipValue = vflipswitch.checked ? 1 : 0;  // Convert true to 1, false to 0
    // Update UI with the new value
    updateUI({ hflip: hflipValue, vflip: vflipValue });
    // Update server settings and wait for it to complete
    updateRestartSettings({ hflip: hflipValue, vflip: vflipValue })
        .then(() => {
            // Refresh the camera feed after updating server settings
            refreshCameraFeed();
        })
        .catch(error => {
            console.error('Error updating server settings:', error);
            // Handle the error if needed
        });
}

</script>

{% endblock %}

